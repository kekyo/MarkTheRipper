---
title: レイアウトの基本
lang: ja-jp
date: 10/26/2022 22:24:54 +09:00
---

「レイアウト」は、記事のHTMLテンプレートに相当します。
MarkTheRipperは、マークダウンに書かれた情報を元にHTMLを生成しますが、このHTMLをレイアウトで定義することで、柔軟にページをカスタマイズできます。

MarkTheRipperのレイアウトは、非常にシンプルでありながら、必要十分な柔軟性と応用性を備えています。
レイアウトは、「メタデータ辞書」を参照することで、すべてのキーワード置換を実現します。

レイアウトの置換例を示します。

## キーワードの置き換え

もっとも簡単な例は、単純なキーワードの置き換えです。次のようなレイアウトを定義したとします:

```html
<title>{title}</title>
```

これは、メタデータ辞書の`title`というキーワードに対応する値に置き換えます。
`title`の値はどこにあるかというと、対応するマークダウン文書の先頭で定義します:

```markdown
---
title: Hello MarkTheRipper!
---

(... 本文 ...)
```

他のサイトジェネレーターを試したことがある場合は、マークダウンにこのような特別な「ヘッダ行」を追加して、タイトルや日時などを挿入する方法を知っているかもしれません。
MarkTheRipperも、構文上はこの慣例に従っていますが、もっと柔軟です。例えば、以下の例は全く同じ結果を生成します:

```html
<title>{foobar}</title>
```

```markdown
---
foobar: Hello MarkTheRipper!
---

(... 本文 ...)
```

* 補足: このヘッダの事を、他のサイトジェネレーターでは「FrontMatter」と呼び、YAML構文で記述することになっていますが、
  MarkTheRipperは厳密にはYAMLではなく、記述の柔軟性を高めるための構文を使用しています。
  例えば、`title`は、ダブルクオートで括る事は必須ではありませんし、`tags`は角括弧で括らなくても正しく認識されます。
  念のため、MarkTheRipperでは、FrontMatterという用語を使っていません。

何となく、メタデータ辞書をどう活用すれば良いか、見えてきましたか？
つまりMarkTheRipperは、マークダウンのヘッダに書いた「キーワードと値」の組をメタデータ辞書として扱うことが出来て、レイアウト上にいくつでも反映することが出来ます。

任意のキーワードを、レイアウト上の任意の箇所で置き換えできるので、例えば以下のような応用が可能です:

```html
<link rel="stylesheet" href="{stylesheet}.css">
```

```markdown
---
title: Hello MarkTheRipper!
stylesheet: darcula
---

(... 本文 ...)
```

恐らく、この機能だけでも、大部分の問題は解決すると思います。

## 特殊なキーワードとフォールバック

このメタデータ辞書には、特殊な、しかし重要と思われるキーワードがいくつか存在します。以下に示します:

|キーワード|内容|
|:----|:----|
|`generated`|MarkTheRipperでサイトを生成した日時|
|`layout`|適用するレイアウト名|
|`lang`|ロケール(`en-us`や`ja-jp`など)|
|`date`|記事の日時|
|`timezone`|MarkTheRipperでサイトを生成した環境のタイムゾーン。IANA表記、または時間|
|`published`|明示的に`false`と指定する事で、このマークダウンを無視する|

* この他にもいくつか特殊なキーワードがありますが、後で解説します。

これらのキーワードは、マークダウンのヘッダに書いて、上書きする事が出来ます。
`generated`を上書きする事に意味は無いかも知れませんが、
MarkTheRipperがメタデータ辞書の定義を特別扱いしない、と言う事だけ知っておけば問題ありません。

上記のキーワードのうち、`lang`や`layout`や`timezone`のデフォルト値は何なのかが気になった人もいると思います。
メタデータ辞書は、サイト生成時のベースとなる定義を、`metadata.json`に配置することが出来ます。
（無くても構いません。実際、minimumサンプルには存在しません）
例えば、以下のような定義です:

```json
{
  "title": "(Draft)",
  "author": "Mark the Ripper",
  "layout": "page",
  "lang": "ja-jp",
  "timezone": "Asia/Tokyo",
}
```

これを見ると面白いことがわかります。`title`キーワードの値が"(Draft)"となっています。例えば、以下のようなレイアウトを考えます:

```html
<meta name="author" content="{author}" />
<title>{title}</title>
```

もし、マークダウンに`title`を指定した場合は、そのタイトルが挿入されますが、指定しなかった場合は"(Draft)"というタイトルが挿入されます。
同様に、`author`を指定した場合は、その投稿者名が挿入されますが、指定しなかった場合は"Mark the Ripper"という投稿者名が挿入されます。

ブログに使うことを考えた場合、殆どの投稿文書はあなた自身が書いたものとなるので、いちいちマークダウンのヘッダに自分の名前を書きたいとは思わないでしょう。
しかし、タイトルはもちろん、その投稿毎に異なるはずです。
そのような場合分けに、このメタデータ辞書の「フォールバック」機能を使うことが出来ます。

そして、`layout`と`lang`のフォールバックですが:

* `layout`がフォールバックにも見つからない場合に限り、`page`というレイアウト名が使われます。
* `lang`がフォールバックにも見つからない場合に限り、システムのデフォルト言語が適用されます。
* `timezone`がフォールバックにも見つからない場合に限り、システムのタイムゾーン設定が適用されます。

レイアウト名には、少し補足が必要でしょう。レイアウト名は、変換元のレイアウトファイルの特定に使用されます。
例えば、レイアウト名が`page`の場合は、`layouts/page.html`ファイルが使用されます。もし:

```markdown
---
title: Hello MarkTheRipper!
layout: fancy
---

(... 本文 ...)
```

のように指定した場合は、`layouts/fancy.html`が使用されます。

`date`は記事の日時を表していて、普通のキーワードと同様に扱われますが、
マークダウンヘッダに定義されていなかった場合は、自動的に生成時の日時が挿入されます。

`timezone`は、`date`のような日時を扱う場合に参照され、タイムゾーン補正を行う基準となります。
MarkTheRipperを動作させる環境の、システムのタイムゾーン設定が、日常的に記事に埋め込む日時と異なる場合は、
`metadata.json`ファイルに含めておくと良いでしょう
（このような代表的な環境として、GitHub Actionsなどのクラウドサービス上で動作させる場合が考えられます）。

`lang`は、単に普通のキーワードの一つのようにしか感じられないかも知れません。
これについては、後の節で解説します。

## 再帰キーワード検索

メタデータ辞書で引いた結果をキーワードとして、再度メタデータ辞書から引きたいと思うことがあります。例えば:

```markdown
---
title: Hello MarkTheRipper!
category: blog
---

(... 本文 ...)
```

`category`とは、記事のカテゴリです。ここでは、`blog`と名付けていますが、以下のようにキーワード参照した場合:

```html
<p>Category: {category}</p>
```

HTMLには `Category: blog` のように表示されます。これで問題ない場合もありますが、もっと丁寧な文に置き換えたいかもしれません。
そこで、`blog`をキーワードとして、再度メタデータ辞書から値を検索させることが出来ます。
MarkTheRipperに組み込まれている、`lookup` 関数キーワードを使用します:

```html
<p>Category: {lookup category}</p>
```

* 関数キーワードの詳細については、後の章で説明します。

こうしておいて、メタデータ辞書に、`blog`と`私的な日記` を対にして登録しておけば、HTMLには `Category: 私的な日記` と表示されます。

このようなキーワードと値のペアは、前節で示した`metadata.json`に書いておけば参照出来るようになります。
加えて、実はメタデータ辞書のファイルは、`metadata/*.json`でマッチするすべてのJSONファイルが対象です。
ファイルが分かれていても、MarkTheRipperが起動する時に、すべて読み込まれて内容がマージされます。

例えば、記事カテゴリだけを管理するファイルとして、`metadata/category.json`のように別のファイルにしておけば、管理が容易になるでしょう。

## 列挙とネスト

タグやカテゴリのような分類は、メニューから選択させてそのページに遷移させたいと思うでしょう。
例えば、サイト全体でタグが5個あったとします。これをページのメニューに自動的に加えて、
メニューからタグに分類されたページに遷移できるようにするには、「列挙機能」を使います。

例によって、小さい例から始めましょう。これはminimumに含まれているレイアウトです:

```html
<p>Tags:{foreach tags} '{item}'{end}</p>
```

* `tags`キーワードは、タグのリストを示します（後述）

これは、`{foreach tags}`と`{end}`の間にある文書が、`tags`の個数だけ繰り返し出力されるというものです。
「間にある文書」とは、ここでは ` '{item}'` の事です。スペースが含まれてることに注意してください。
同様に、改行やHTMLのタグなど、この間には何を含んでいても構いません。

では、以下のようなマークダウンを変換したとします:

```markdown
---
title: Hello MarkTheRipper
tags: foo,bar,baz
---

(... 本文 ...)
```

すると、`<p>Tags: 'foo' 'bar' 'baz'</p>` と出力されます。
`tags`の`foo,bar,baz`が、スペースで区切られて展開されて、クオートされて出力されました。

`{foreach tags}`と`{end}`の間にある文書が繰り返し出力されるので、以下のように使う事も出来ます:

```html
<ul>
  {foreach tags}
  <li>{item.index}/{item.count} {item}</li>
  {end}
</ul>
```

結果:

```html
<ul>
  <li>0/3 foo</li>
  <li>1/3 bar</li>
  <li>2/3 baz</li>
</ul>
```

間に挿入されている`{item}`は、繰り返される一つ一つの値を参照できるキーワードです。
また、`{item.index}` と指定すると、0から始まって1,2,3... とカウントする数値が得られます。
`{item.count}` は、繰り返しの個数です。上記ではタグが3個あるため、この値は常に3となります。

さらに、複数のキーワードをネストさせる事も出来ます。以下の例は、タグを2重に繰り返します:

```html
<ul>
  {foreach tags}
  {foreach tags}
  <li>{item.index} {item}</li>
  {end}
  {end}
</ul>
```

結果:

```html
<ul>
  <li>0 foo</li>
  <li>1 bar</li>
  <li>0 foo</li>
  <li>1 bar</li>
</ul>
```

ところで、この場合の`item`は、2重にネストした内側の`tags`の繰り返しを指している事に注意して下さい。
場合によっては、外側の繰り返しの値を使いたいと思うかもしれません。
その場合は、`foreach`に「束縛名」を指定します:

```html
<ul>
  {foreach tags tag1}
  {foreach tags tag2}
  <li>{tag1.index}-{tag2.index} {tag1}/{tag2}</li>
  {end}
  {end}
</ul>
```

結果:

```html
<ul>
  <li>0-0 foo/foo</li>
  <li>0-1 foo/bar</li>
  <li>1-0 bar/foo</li>
  <li>1-1 bar/bar</li>
</ul>
```

束縛名を省略した場合は、`item`が使用されます。
これで、`foreach`による繰り返しの使い方が把握できたと思います。

## マークダウン中のキーワードの置き換え

これまでに説明してきたキーワードの置き換えは、レイアウトファイルに対して行うというものでした。
このキーワード置き換え機能は、マークダウンファイルにも同様に適用されます。例えば:

```markdown
---
title: hoehoe
tags: foo,bar,baz
---

Title: {title}
```

このようなマークダウンを記述すると、`{title}`が同じようにキーワード置換されます。
もちろんこれまでに説明してきた、関数キーワードによる計算も可能です。

マークダウン上のキーワード置き換えは、コードブロックに対しては機能しません:

````markdown
---
title: hoehoe
tags: foo,bar,baz
---

Title: `{title}`

```
{title}
```
````

上記のように、コードブロック内に配置された`{...}`は、MarkTheRipperで解釈されずに、そのまま出力されます。
